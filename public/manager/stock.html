<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kulfi ERP | Stock Management</title>
    <link rel="stylesheet" href="../css/manager/stock.css" />
    <script src="https://unpkg.com/lucide@latest"></script>
  </head>

  <body>
    <div id="auth-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0f2f5; z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner" style="width: 50px; height: 50px; border: 4px solid #ddd; border-top: 4px solid #ff5722; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
        <h4 style="margin-top: 15px; font-family: sans-serif; color: #555;">Loading Stock Data...</h4>
    </div>
    <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>

    <header class="topbar">
      <div class="header-left">
        <button id="menu-btn" class="menu-toggle"><i data-lucide="menu"></i></button>
        <h2>Kulfi ERP</h2>
      </div>
      <div class="user-info">
        <span class="role-badge">Manager</span>
        <div class="profile-icon">
          <img src="https://ui-avatars.com/api/?name=Manager+User&background=0D8ABC&color=fff" alt="User" />
        </div>
      </div>
    </header>

    <div class="layout">
      <aside class="sidebar" id="sidebar">
        <button id="close-sidebar" class="close-btn">&times;</button>
        <div class="sidebar-header"><h3>Menu</h3></div>
        <nav class="nav-links">
          <a href="./dashboard.html"><i data-lucide="layout-dashboard"></i> Dashboard</a>
          <a href="./stock.html" class="active"><i data-lucide="package"></i> Stock</a>
          <a href="./sales.html"><i data-lucide="bar-chart-3"></i> Sales/Purchase</a>
          <a href="./credit.html"><i data-lucide="credit-card"></i> Credit</a>
          <a href="./shops.html"><i data-lucide="store"></i> Shops</a>
          <a href="./expense.html"><i data-lucide="banknote"></i> Expenses</a>
          <a href="./staff.html"><i data-lucide="users"></i> Staff</a>
          <a href="#" id="logout-btn" class="logout"><i data-lucide="log-out"></i> <span>Logout</span></a>        
        </nav>
      </aside>

      <div class="overlay" id="overlay"></div>

      <main class="content">
        <div class="page-header">
          <h3>Stock Management</h3>
          <div class="header-actions">
            <button class="btn btn-assign" id="assign-stock-btn"><i data-lucide="arrow-right-circle"></i> Assign to Boy</button>
            <button class="btn btn-return" id="return-stock-btn"><i data-lucide="arrow-left-circle"></i> Return Stock</button>
            <button class="btn btn-damage" id="damage-stock-btn"><i data-lucide="alert-triangle"></i> Damaged Entry</button>
          </div>
        </div>

        <div class="stats-row">
          <div class="mini-card">
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div><span>Godown Stock</span><div id="godown-stats-display"><h4>Loading...</h4></div></div>
              <div class="icon-box" style="background:#e3f2fd; padding:10px; border-radius:50%;"><i data-lucide="package" style="color:#0D8ABC;"></i></div>
            </div>
          </div>

          <div class="mini-card info">
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div><span id="boy-stock-title">Stock with Boys</span><h4 id="boy-stock-count">0 Items</h4></div>
              <div class="icon-box" style="background:#e1f5fe; padding:10px; border-radius:50%;"><i data-lucide="users" style="color:#0288d1;"></i></div>
            </div>
          </div>

          <div class="mini-card danger">
            <div style="display:flex; justify-content:space-between; align-items:start;">
              <div><span>Out of Stock</span><h4>0 Items</h4></div>
              <div class="icon-box" style="background:#fdedec; padding:10px; border-radius:50%;"><i data-lucide="alert-circle" style="color:#e74c3c;"></i></div>
            </div>
          </div>

          <div class="mini-card danger" id="damage-card-click" style="position: relative; cursor: pointer;">
             <div style="display:flex; justify-content:space-between; align-items:start;">
              <div>
                  <span>Total Damaged</span>
                  <div id="total-damaged-display">
                      <h4>0 Units</h4>
                  </div>
              </div>
              <div class="icon-box" style="background:#fdedec; padding:10px; border-radius:50%;"><i data-lucide="archive" style="color:#c0392b;"></i></div>
            </div>
            
            <button id="reset-damage-btn" title="Reset Counter" style="position: absolute; top: 5px; right: 5px; background: none; border: none; cursor: pointer; padding: 5px; z-index: 10;">
              <i data-lucide="rotate-ccw" style="width: 14px; height: 14px; color: #777;"></i>
            </button>
          </div>
        </div>

        <div class="filter-bar">
          <div class="search-box"><i data-lucide="search"></i><input type="text" id="stock-search" placeholder="Search product..." /></div>
          <select class="filter-select" id="stock-category-filter">
            <option value="all">All Categories</option><option value="kulfi">Kulfi</option><option value="ice-cream">Ice Cream</option><option value="Candy">Candy</option><option value="Cup">Cup</option><option value="Cone">Cone</option><option value="Raw Material">Raw Material</option>
          </select>
          <select class="filter-select" id="boy-stock-filter" style="border-color: var(--info);"><option value="all">All Boys Stock</option></select>
        </div>

        <div class="table-container">
          <table>
            <thead><tr><th>Product Name</th><th>Packets</th><th>Total Units</th><th>Category</th><th>Price (₹)</th><th>Status</th><th>Action</th></tr></thead>
            <tbody id="stock-table-body"><tr><td colspan="7" style="text-align: center">Loading...</td></tr></tbody>
          </table>
        </div>
      </main>
    </div>

    <div id="assign-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3>Assign Stock</h3><button class="close-modal" data-target="assign-modal">&times;</button></div>
        <div class="modal-body">
          <form id="assign-form">
            <div class="form-group"><label>Select Delivery Boy</label><select id="assign-boy-select" required><option value="">-- Select --</option></select></div>
            <div class="form-group"><label>Select Product</label><select id="assign-product-select" required><option value="">-- Select Product --</option></select></div>
                      <div class="form-group">
              <label>Current Price (Per Unit)</label>
              <input type="text" id="assign-price" readonly style="background-color: #f0f0f0; cursor: not-allowed; font-weight: bold; color: #333;" placeholder="Rate auto-filled">
          </div>
            <div class="form-row" style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><label>Packets</label><input type="number" id="assign-packets" placeholder="Pkts"></div><div class="form-group" style="flex:1;"><label>Pieces (Loose)</label><input type="number" id="assign-pieces" placeholder="Pcs"></div></div>
            <button type="submit" class="save-btn" style="background: var(--info)">Assign Stock</button>
          </form>
        </div>
      </div>
    </div>

    <div id="return-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3>Return Stock</h3><button class="close-modal" data-target="return-modal">&times;</button></div>
        <div class="modal-body">
          <form id="return-form">
            <div class="form-group"><label>Select Delivery Boy</label><select id="return-boy-select" required><option value="">-- Select --</option></select></div>
            <div class="form-group"><label>Select Product</label><select id="return-product-select" required><option value="">-- Select Product --</option></select></div>
            <div class="form-group">
    <label>Product Price (Per Unit)</label>
    <input type="text" id="return-price" readonly style="background-color: #f0f0f0; cursor: not-allowed; font-weight: bold; color: #333;" placeholder="Rate auto-filled">
</div>
            <div class="form-row" style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><label>Packets</label><input type="number" id="return-packets" placeholder="Pkts"></div><div class="form-group" style="flex:1;"><label>Pieces (Loose)</label><input type="number" id="return-pieces" placeholder="Pcs"></div></div>
            <button type="submit" class="save-btn" style="background: var(--warning)">Process Return</button>
          </form>
        </div>
      </div>
    </div>

    <div id="damage-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3>Report Damage (Manual)</h3><button class="close-modal" data-target="damage-modal">&times;</button></div>
        <div class="modal-body">
          <form id="damage-form">
            <div class="form-group"><label>Category</label><select id="damage-category" required><option value="">-- Select Category --</option><option value="kulfi">Kulfi</option><option value="ice-cream">Ice Cream</option><option value="Candy">Candy</option><option value="Cup">Cup</option><option value="Cone">Cone</option><option value="Raw Material">Raw Material</option></select></div>
            <div class="form-group"><label>Item Name</label><input type="text" id="damage-product-name" list="damage-name-list" placeholder="Enter Item Name" required><datalist id="damage-name-list"></datalist></div>
            <div class="form-row" style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><label>Packets</label><input type="number" id="damage-packets" placeholder="Pkts"></div><div class="form-group" style="flex:1;"><label>Pieces (Loose)</label><input type="number" id="damage-pieces" placeholder="Pcs"></div></div>
            <div class="form-group"><label>Reason</label><input type="text" id="damage-reason" placeholder="Reason" /></div>
            <button type="submit" class="save-btn" style="background: var(--danger)">Save Entry</button>
          </form>
        </div>
      </div>
    </div>

    <div id="damage-history-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3>Damage History</h3><button class="close-modal" data-target="damage-history-modal">&times;</button></div>
        <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
            <table style="width:100%; border-collapse: collapse; font-size: 13px;">
                <thead style="background: #f8f9fa;">
                    <tr>
                        <th style="padding: 8px; text-align: left;">Item</th>
                        <th style="padding: 8px; text-align: left;">Qty</th>
                        <th style="padding: 8px; text-align: right;">Action</th>
                    </tr>
                </thead>
                <tbody id="damage-history-list">
                    </tbody>
            </table>
        </div>
      </div>
    </div>

    <div id="edit-stock-modal" class="modal-overlay">
      <div class="modal-content">
        <div class="modal-header"><h3>Edit Product Details</h3><button class="close-modal" data-target="edit-stock-modal">&times;</button></div>
        <div class="modal-body">
          <form id="edit-stock-form">
            <input type="hidden" id="edit-id">
            <div class="form-group"><label>Product Name</label><input type="text" id="edit-name" required placeholder="Name"></div>
            <div class="form-group"><label>Category</label><select id="edit-category" required><option value="kulfi">Kulfi</option><option value="ice-cream">Ice Cream</option><option value="Candy">Candy</option><option value="Cup">Cup</option><option value="Cone">Cone</option><option value="Raw Material">Raw Material</option></select></div>
            <div class="form-row" style="display:flex; gap:10px;"><div class="form-group" style="flex:1;"><label>Total Units</label><input type="number" id="edit-qty" required placeholder="Qty"></div><div class="form-group" style="flex:1;"><label>Items/Pkt</label><input type="number" id="edit-packet-size" required placeholder="Size"></div></div>
            <div class="form-group"><label>Price (₹)</label><input type="number" id="edit-price" required placeholder="Price"></div>
            <button type="submit" class="save-btn" style="background: var(--success)">Update Product</button>
          </form>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="../js/firebase-config.js"></script>
    <script src="../js/manager/backend/authGuard.js"></script>
    <script src="../js/manager/stock/backend/stockService.js"></script>
    <script src="../js/manager/stock/ui/stockUI.js"></script>
    <script src="../js/manager/stock/backend/stockController.js"></script>
    <script src="../js/manager/stock/stockMain.js"></script>
  </body>
</html>